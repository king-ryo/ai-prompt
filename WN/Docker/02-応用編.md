# 2. 応用編：仕組みの理解と実環境構築（目安：6時間）

基礎編では「既存のコンテナ」を使いましたが、応用編では**「自分で作ったプログラム」**をコンテナ化し、さらにデータベースと連携させます。

## 2-1. Dockerの仕組みとDocker Hub（1時間）

なぜDockerはこれほど軽量で、スムーズに動くのでしょうか？その裏側を少しだけ覗いてみます。

### **1. アーキテクチャ（クライアントとデーモン）**

あなたがターミナルで打っている `docker` コマンドは、実は**リモコン（Client）**に過ぎません。実際に裏でコンテナを作ったり動かしたりしているのは、**Docker Daemon（Server）**という常駐プログラムです。

### **2. イメージのレイヤ（層）構造**

Dockerイメージは、一枚の巨大なファイルではなく、薄い層（レイヤ）の積み重ねでできています。

* **例:** `Ubuntu`の土台の上に `Python`を重ね、その上に `自分のソースコード` を重ねる。
* **メリット:** 変更があった部分（自分のコード）だけを作り直せば良いため、ビルドや転送が高速です。

### **3. Docker Hubの活用**

* **Docker Hub:** GitHubの「Dockerイメージ版」です。世界中の公式ソフト（MySQL, Python, Node.jsなど）が登録されています。
* **タグ（Tag）:** イメージにはバージョンがあります。`python:3.9` や `mysql:8.0` のように、`名前:タグ` で指定するのが一般的です（指定しないと自動で最新版 `latest` になります）。

---

## 2-2. Dockerfileによるイメージ作成（1.5時間）

ここからハンズオン再開です。既存のNginxではなく、**「自分が作ったファイルを内包したWebサーバ」**を作ります。

### **Step 1: 準備**

デスクトップなどに `docker-practice` というフォルダを作り、その中に `web` というフォルダを作ってください。

### **Step 2: HTMLファイルの作成**

`web` フォルダの中に、`index.html` を作成します。

```html
<h1>Hello, My Docker!</h1>
<p>これは自作イメージから起動したコンテナです。</p>

```

### **Step 3: Dockerfileの作成**

同じ `web` フォルダに、`Dockerfile`（拡張子なし）という名前のファイルを作成します。これが「設計図」です。

```dockerfile
# 1. ベースとなるイメージを指定（Nginxを使う）
FROM nginx:alpine

# 2. 自分の作ったhtmlを、コンテナ内の所定の場所にコピーする
COPY index.html /usr/share/nginx/html/index.html

```

### **Step 4: ビルド（イメージの作成）**

ターミナルで `web` フォルダに移動し、以下のコマンドを実行します。

```bash
# ドット(.) は「今の場所にあるDockerfileを使え」という意味
docker build -t my-custom-web .

```

### **Step 5: 自作イメージの起動**

```bash
docker run -d -p 8081:80 my-custom-web

```

ブラウザで **http://localhost:8081** にアクセスし、自分で書いた「Hello, My Docker!」が表示されれば成功です！

---

## 2-3. 3層アプリケーションの構築（3.5時間）

ここが本カリキュラムのゴールです。
**Web（Nginx） ⇔ App（Python） ⇔ DB（PostgreSQL）** が連携するシステムを構築します。
コマンドを1つずつ打つのは大変なので、**Docker Compose** というツールを使って「構成管理」を行います。

### **Step 1: ディレクトリ構成の作成**

`docker-practice` フォルダの下に、以下の構成を作ってください。

```text
docker-practice/
├── docker-compose.yml   # 全体の設計図
└── app/                 # Pythonアプリ用フォルダ
    ├── Dockerfile       # Pythonアプリの設計図
    ├── app.py           # プログラム本体
    └── requirements.txt # 必要なライブラリリスト

```

### **Step 2: アプリケーションの作成 (App層)**

**`app/app.py`** (DBに接続して現在の時刻を表示する簡単なアプリ)

```python
import time
import psycopg2
from flask import Flask

app = Flask(__name__)

# DB接続を試みる（失敗したらリトライ）
def get_db_connection():
    while True:
        try:
            conn = psycopg2.connect(
                host="db",           # docker-composeで定義するサービス名
                database="mydb",
                user="user",
                password="password"
            )
            return conn
        except psycopg2.OperationalError:
            time.sleep(1)

@app.route('/')
def hello():
    conn = get_db_connection()
    cur = conn.cursor()
    cur.execute('SELECT NOW();')
    time_now = cur.fetchone()[0]
    cur.close()
    conn.close()
    return f'Hello from 3-Tier App! DB Time: {time_now}'

if __name__ == "__main__":
    app.run(host='0.0.0.0', port=5000)

```

**`app/requirements.txt`**

```text
flask
psycopg2-binary

```

**`app/Dockerfile`**

```dockerfile
FROM python:3.9-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY app.py .
CMD ["python", "app.py"]

```

### **Step 3: Docker Composeの作成（全体定義）**

**`docker-compose.yml`**
このファイル一つで、3つのコンテナの設定（ポート、ネットワーク、ボリューム）を全部書きます。

```yaml
version: '3.8'

services:
  # 1. Webサーバ (Nginx)
  web:
    image: nginx:alpine
    ports:
      - "80:80"
    depends_on:
      - app
    # 簡単なリバースプロキシ設定をコマンドで直接書き込む（本来はconfファイル推奨）
    command: > 
      /bin/sh -c "echo 'server { listen 80; location / { proxy_pass http://app:5000; } }' > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"

  # 2. アプリサーバ (Python)
  app:
    build: ./app
    depends_on:
      - db

  # 3. データベース (PostgreSQL)
  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: mydb
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    volumes:
      - db-data:/var/lib/postgresql/data # データの永続化

volumes:
  db-data:

```

### **Step 4: 起動と確認**

ターミナルで `docker-compose.yml` がある場所へ移動し、魔法のコマンドを打ちます。

```bash
docker compose up -d --build

```

※ 古いバージョンの場合は `docker-compose`（ハイフンあり）の場合があります。

**動作確認:**

1. ビルドとダウンロードが始まります（数分かかります）。
2. 完了したら、ブラウザで **http://localhost** にアクセスしてください。
3. 画面に `Hello from 3-Tier App! DB Time: 202X-XX-XX...` と表示されれば大成功です！
* **Nginx** がリクエストを受け取り、
* **App** に転送し、
* **App** が **DB** から時間を取得して返しました。



### **Step 5: 片付け**

完了したら、環境を丸ごと削除します。

```bash
docker compose down

```

もし「データの永続化（Volume）」の効果を確認したければ、一度 `down` してから再度 `up` してみてください。DBのデータが消えずに残っているはずです。

---

## 応用編まとめと次のステップ

お疲れ様でした！これであなたは以下のことができます。

1. **仕組みの理解:** イメージ、コンテナ、Hubの関係がわかる。
2. **作成:** Dockerfileで自分のアプリをコンテナ化できる。
3. **構築:** Docker ComposeでWeb/App/DBを連携させることができる。

**次のステップ:**

* 実際の開発プロジェクトで `docker-compose.yml` を書いてみる。
* 作成したイメージをAWSやGoogle Cloudなどのクラウド環境（ECSやCloud Run）にデプロイしてみる。